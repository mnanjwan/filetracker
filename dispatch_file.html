<!doctype html>

<html lang="en" data-layout="horizontal" data-layout-style="default" data-layout-position="fixed" data-topbar="light"
    data-sidebar-visibility="show" data-sidebar="light" data-sidebar-size="lg" data-bs-theme="light"
    data-layout-width="fluid" data-preloader="disable">

<head>

    <meta charset="utf-8" />
    <title>FileTrakA</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta content="FileTrakA" name="description" />
    <!-- App favicon -->
    <link rel="shortcut icon" href="assets/images/favicon.ico">
    <!-- Style css -->

    <!-- jsvectormap css -->
    <link href="assets/libs/jsvectormap/css/jsvectormap.min.css" rel="stylesheet" type="text/css" />

    <!--Swiper slider css-->
    <link href="assets/libs/swiper/swiper-bundle.min.css" rel="stylesheet" type="text/css" />

    <!-- Layout config Js -->
    <script src="assets/js/layout.js"></script>
    <!-- Bootstrap Css -->
    <link href="assets/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <!-- Icons Css -->
    <link href="assets/css/icons.min.css" rel="stylesheet" type="text/css" />
    <!-- App Css-->
    <link href="assets/css/app.min.css" rel="stylesheet" type="text/css" />
    <!-- custom Css-->
    <link href="assets/css/custom.min.css" rel="stylesheet" type="text/css" />
    <!-- MDB icon -->
    <link rel="icon" href="img/mdb-favicon.ico" type="image/x-icon" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css" />
    <!-- Google Fonts Roboto -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" />
    <!-- MDB -->
    <link rel="stylesheet" href="css/bootstrap-video-carousel.min.css" />

    <style>
        /* Carousel styling */
        #introCarousel,
        .carousel-inner,
        .carousel-item,
        .carousel-item.active {
          height: 100vh;
        }
  
        .carousel-item:nth-child(1) {
          background-repeat: no-repeat;
          background-size: cover;
          background-position: center center;
        }
  
        .carousel-item:nth-child(2) {
          background-repeat: no-repeat;
          background-size: cover;
          background-position: center center;
        }
  
        .carousel-item:nth-child(3) {
          background-repeat: no-repeat;
          background-size: cover;
          background-position: center center;
        }
  
        /* Height for devices larger than 576px */
        @media (min-width: 992px) {
          #introCarousel {
            margin-top: -58.59px;
          }
        }
  
        .navbar .nav-link {
          color: #fff !important;
        }
      </style>


</head>

<body>

    <!-- Begin page -->
    <div id="layout-wrapper">


        <!-- Navigation Links -->
        <div style="width: 100%; top: 0;" id="navbar-container"></div>
        
        <!-- Left Sidebar End -->
        <!-- Vertical Overlay-->
        <div class="vertical-overlay"></div>

            <footer class="footer">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-sm-6">
                            <script>document.write(new Date().getFullYear())</script> Â© FileTrakA. Nigeria Customs
                            Service. All rights reserved. Powered by ED Antia psc Assistant Comptroller of Customs
                        </div>
                        <div class="col-sm-6">
                            <div class="text-sm-end d-none d-sm-block">
                                <a href="">FAQ</a>
                            </div>
                        </div>
                    </div>
                </div>
            </footer>
        </div>
        <!-- end main content-->

        <!-- end main content-->

    </div>
    <!-- END layout-wrapper -->
	 



    <!--start back-to-top-->
    <button onclick="topFunction()" class="btn btn-danger btn-icon" id="back-to-top">
        <i class="ri-arrow-up-line"></i>
    </button>
    <!--end back-to-top-->

    <!--preloader-->
    <div id="preloader">
        <div id="status">
            <div class="spinner-border text-primary avatar-sm" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>



    <!-- JAVASCRIPT -->
    <script src="js/main.js"></script>
    <script src="js/commands.js"></script>
	<script>
        document.addEventListener('DOMContentLoaded', function () {
        // Handle logout function
        function handleLogout(event) {
            event.preventDefault(); // Prevent default anchor action
            console.log('Logout button clicked'); // Debug log to confirm click event

            // Show confirmation dialog
            const userConfirmed = window.confirm("Are you sure you want to log out?");

            if (userConfirmed) {
                console.log('User confirmed logout');

                // Clear all localStorage items
                localStorage.clear();
                console.log("Local storage cleared. User logged out.");

                // Redirect to index page
                window.location.href = "./index.html"; 
            } else {
                console.log("Logout canceled by the user.");
            }
        }

        const welcomeLoginMessage = document.getElementById('welcome-message-service-number');
        const authToggleLink = document.getElementById('auth-toggle-link');
        const authToggleIcon = document.getElementById('auth-toggle-icon');
        const toggleInstance = document.getElementById('toggle-instance');

        // Check for user data in localStorage
        let userData = JSON.parse(localStorage.getItem("userData"));
        const token = userData?.token;

        console.log(userData);

        if (!token || token === undefined) {
            // If no token, clear all localStorage items and exit
            localStorage.clear();

            toggleInstance.textContent = "Login";
            authToggleIcon.className = "mdi mdi-login text-muted fs-16 align-middle me-1";
            authToggleLink.href = "login.html"; // Redirect to login page
            authToggleLink.removeEventListener("click", handleLogout);
            return;
        }

        // Validate the token by hitting the /user/profile endpoint
        fetch("/user/profile", {
            method: "GET",
            headers: {
                "Authorization": `Bearer ${token}`
            }
        })
        .then(response => {
            if (!response.ok) {
                console.log('Invalid token, logging out:', response);
                localStorage.clear();
                window.location.href = "./index.html";
                return;
            }
            return response.json();
        })
        .then(profileData => {
            console.log("Profile Data:", profileData);

            // Load appropriate navbar based on userType
            if (userData?.userType) {
                let navbarFile = userData.userType === 'admin' ? 'admin-nav.html' : 'service-men-nav.html';

                // Fetch and insert the appropriate navbar HTML
                fetch(navbarFile)
                    .then(response => response.text())
                    .then(data => {
                        // Insert the navbar HTML
                        document.getElementById('navbar-container').innerHTML = data;

                        console.log("profileData before setting element",profileData)

                        // After navbar is loaded, access and update elements within it
                        const serviceNumberElement = document.getElementById('serviceNumber');
                        const departmentElement = document.getElementById('department');
                        const usernameElement = document.getElementById('user-profile-name');

                        const welcomeLoginMessage = document.getElementById('welcome-message-service-number');
                        const authToggleLink = document.getElementById('auth-toggle-link');
                        const authToggleIcon = document.getElementById('auth-toggle-icon');
                        const toggleInstance = document.getElementById('toggle-instance');

                        // Set the service number and department if they exist
                        if (profileData.serviceNumber) {
                            serviceNumberElement.textContent = profileData.serviceNumber;
                            departmentElement.textContent = `UNIT: ${profileData.department}`;
                            usernameElement.textContent = profileData.username;
                            welcomeLoginMessage.textContent = `Welcome ${profileData.serviceNumber}!`;

                            toggleInstance.textContent = "Logout";
                            authToggleIcon.className = "mdi mdi-logout text-muted fs-16 align-middle me-1";
                            authToggleLink.href = "#"; // Prevent default link behavior
                            authToggleLink.addEventListener("click", handleLogout);
                        } else {
                            serviceNumberElement.textContent = "";
                            welcomeLoginMessage.textContent = "";
                        }

                        if (profileData.department) {
                            departmentElement.textContent = `UNIT: ${profileData.department}`;
                        } else {
                            departmentElement.textContent = "";
                        }

                        if (profileData.username) {
                        } else {
                            usernameElement.textContent = "";
                        }

                        // Determine the current page URL
                        const currentPath = window.location.pathname.split('/').pop(); // Get the current page file name

                        // Select the nav links
                        const navLinks = document.querySelectorAll('.nav-link');

                        // Add 'active' class to the current link
                        navLinks.forEach(link => {
                            if (link.getAttribute('href') === currentPath) {
                                link.classList.add('active');
                            }
                        });
                    })
                    .catch(error => {
                        console.error("Error loading the navbar:", error);
                    });
            } else {
                localStorage.clear();
                console.error("User data not found or invalid in localStorage.");
                window.location.href = "./index.html";
            }
        })
        .catch(error => {
            localStorage.clear();
            console.error("Error fetching profile data:", error);
        });

        // If userData exists, update UI for logged-in state
        if (userData) {
            try {
                console.log('User is logged in. Updating UI...');
            } catch (error) {
                console.error("Error parsing userData:", error);
            }
        } else {
            console.log("No userData found in localStorage. Showing LOG IN button.");
        }
    });
    </script>
    
    <script>
    document.getElementById('reg-command').addEventListener('change', function () {
        const commandId = this.value;
        const departmentSelect = document.getElementById('reg-department');
        const departmentNameInput = document.getElementById('reg-department-name'); // Reference to the hidden input field

        if (commandId) {
        // Fetch units from the server based on the commandId
        fetch(`/units/by-command/${commandId}`)
            .then(response => response.json())
            .then(data => {
            // Clear the current options
            departmentSelect.innerHTML =
                '<option value="">Select Unit</option><option value="create-new">Create New Unit</option>';

            // Add the fetched units
            data.forEach(unit => {
                const option = document.createElement('option');
                option.value = unit.name; // Set unit name as the value
                option.text = unit.name; // Display unit name
                departmentSelect.appendChild(option);
            });
            })
            .catch(err => {
            console.error('Error fetching units:', err);
            });
        } else {
        // Reset if no command is selected
        departmentSelect.innerHTML =
            '<option value="">Select Unit</option><option value="create-new">Create New Unit</option>';
        }
    });

    // Update the hidden input with the unit's name when a unit is selected
    document.getElementById('reg-department').addEventListener('change', function () {
        const selectedUnitName = this.options[this.selectedIndex].text; // Get the name of the selected option
        document.getElementById('reg-department-name').value = selectedUnitName; // Update the hidden input with the name

        // Handle the "Create New Unit" option
        if (this.value === 'create-new') {
        if (!document.getElementById('create-new-unit')) {
            const newUnitInput = document.createElement('input');
            newUnitInput.setAttribute('type', 'text');
            newUnitInput.setAttribute('id', 'create-new-unit');
            newUnitInput.setAttribute('class', 'input100');
            newUnitInput.setAttribute('placeholder', 'New Unit Name');
            this.parentNode.insertBefore(newUnitInput, this.nextSibling);
        }
        } else {
        const createNewUnitField = document.getElementById('create-new-unit');
        if (createNewUnitField) {
            createNewUnitField.remove();
        }
        }
    });
    </script>
    
    
    
    
    <script src="assets/libs/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="assets/libs/simplebar/simplebar.min.js"></script>
    <script src="assets/libs/node-waves/waves.min.js"></script>
    <script src="assets/libs/feather-icons/feather.min.js"></script>
    <script src="assets/js/pages/plugins/lord-icon-2.1.0.js"></script>
    <script src="assets/js/plugins.js"></script>
    
    <script src="assets/libs/simplebar/simplebar.min.js"></script>
    <script src="assets/libs/node-waves/waves.min.js"></script>
    <script src="assets/libs/feather-icons/feather.min.js"></script>
    <script src="assets/js/pages/plugins/lord-icon-2.1.0.js"></script>
    <script src="assets/js/plugins.js"></script>

    <!-- Custom scripts -->
    <script type="text/javascript"></script>
</body>


</html>